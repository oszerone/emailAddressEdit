<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title></title>
<link href="" rel="stylesheet" type="text/css" />
<style type="text/css">
*{
	margin: 0px;
	padding: 0px;
	font-family: 'Microsoft Yahei',verdana;
	font-size: 12px;
}
ul,ol,li{
	list-style-type: none;
}
.info{
	width: 80%;
	height: 300px;
	overflow: auto;
	border: 1px solid gray;
	padding: 2px;
}
.info div{
	width: 5000px;
}
.email-list{
	width: 80%;
	color: #000;
	height: 200px;
	position: relative;
	padding: 2px;
	border: 1px solid gray;
	cursor: text;
}
ul.suggest-email{
	padding: 2px 0px;
	border: 1px solid #AAAAAA;
	background: #FFF;
	float: left;
	position: absolute;
	left: 40px;
	top: 50px;
	cursor: pointer;
}
ul.suggest-email li{
	line-height: 22px;
	padding: 2px 20px 2px 15px;
	background: #fff;
	color: #555;
}
ul.suggest-email li.hover{
	background: #008810;
	color: #fff;
}
.email-list-item, .email-list-item-edit{
	position:relative;
	float: left;
	background: #888888;
	margin: 2px 3px;
	padding: 2px 10px;
	cursor: pointer;
	line-height: 20px;
}
.email-list-item-edit{
	margin:2px 0px;
	padding: 2px 5px;
	background: #fff;
}
.email-list-item-edit input{
	width: 30px;
	outline: 0px;
	border: 0px;
	line-height: 20px;
	position:absolute;
	z-index:9px;
}
.email-list-item-edit span{
	visibility:hidden;
}
</style>
<script>
	var suggestUl, emailListDiv, hoverSuggest;
	window.onload = function(){
		suggestUl = document.getElementById("suggest");
		hoverSuggest = suggestUl.childNodes[0];
		emailListDiv = document.getElementById("emailAddr");
		initEdit();
		bindEvent();
	};
	function initEdit(){
		emailListDiv.innerHTML = '<div id="item-edit" class="email-list-item-edit">'
								+ '<input id="edit" type="text" class="email-edit-input" />'
								+ '<span>WW</span>'
							+ '</div>';
		return emailListDiv.firstChild;
	}
	function bindEvent(){
		var emailEditInput = document.getElementById("edit")
		emailListDiv.onclick = function(e){
			var src = e.target;
			if(src.className === "email-list"){
				emailEditInput.focus();
			}
		}
		suggestUl.onmouseover = function(e){//selection effect
			var src = e.target;
			if(src.tagName.toLowerCase() === "li"){
				hoverSuggestLi(src);
				log("onmouseover: " + htmlEscape(src.innerHTML));
			}
		};
		suggestUl.onclick = function(e){//selct
			var src = e.target;
			while(src.className !== "suggest-email" && src.tagName.toLowerCase() !== "li"){
				src = src.parentNode;
			}
			if(src.tagName.toLowerCase() === "li"){
				log("onclick selected suggest");
				insertSuggest(src);
			}
		};
		//上下箭头移动suggest邮箱地址
		document.onkeydown = function(e){
			var arrowKeyCode = {left:37, up:38, right:39, down:40};
			if(e.keyCode === arrowKeyCode.up || e.keyCode === arrowKeyCode.down){
				var down = e.keyCode === 40;
				var li;
				if(hoverSuggest){
					li = hoverSuggest[down ? "nextSibling" : "previousSibling"];
				}
				if(!li){
					li = suggestUl[down ? "firstChild" : "lastChild"];
				}
				hoverSuggestLi(li);
			}
			if(e.keyCode === 13 && hoverSuggest){
				log("onkeydown 13 select");
				insertSuggest(hoverSuggest);
			}
		};
		emailEditInput.onkeyup = emailEditInput.onkeydown = emailEditInput.onkeypress = function(e){
			keyEventEdit(e);
			arrowAndBackspace(e);
		};
	}
	function createItem(email){
		var div = document.createElement("div");
		var name = email.substring(0, email.indexOf("@"));
		div.innerHTML = '<div class="email-list-item">'
							+ '<strong>' + name + '</strong>'
							+ '<em>&lt;' + email + '&gt;</em>'
						+ '</div>';
		var item = div.firstChild;
		div.removeChild(item);
		return item;
	}
	function keyEventEdit(e){
		var src = e.target;
		var editSpan = src.nextSibling;
		editSpan.innerHTML = src.value + "WW";
		var width = editSpan.offsetWidth < 30 ? 30 : editSpan.offsetWidth;
		src.style.width = width + "px";
		log(now() + " : type = " + e.type + ", keyCode = " + e.keyCode + ", " + editSpan.innerHTML + " " + width);
	}
	function arrowAndBackspace(e){//需要控制时间，防止按住不放时全部删除，或者按住不放只删除一个的交互缺陷
		var editItem = document.getElementById("item-edit");
		var arrAndBackDelKeys = {"8":"backspace","37":"left","39":"right","46":"delete"};
		if(e.keyCode in arrAndBackDelKeys){
			var src = e.target;
			//现在如果删除最后一个字母时会删除前一个item
			if(e.type === "keyup" && src.value === ""){//keyup和keydown改如何抉择
				var item = editItem[(e.keyCode === 39 || e.keyCode === 46) ? "nextSibling" : "previousSibling"];
				if(item){
					if(e.keyCode === 8){
						editItem.parentNode.removeChild(item);
					}else if(e.keyCode === 46){
						editItem.parentNode.removeChild(item);
					}else if(e.keyCode === 37){
						editItem.parentNode.insertBefore(editItem, item);
					}else{
						editItem.parentNode.insertBefore(item, editItem);
					}
				}
				src.focus();
			}
		}
	}
	function insertSuggest(suggestLi){
		var editItem = document.getElementById("item-edit");
		var email = suggestLi.innerHTML.replace(/<[\/]?strong>/g,"");
		editItem.parentNode.insertBefore(createItem(email), editItem);
		var emailEditInput = document.getElementById("edit");
		emailEditInput.value = "";
		emailEditInput.nextSibling.innerHTML = "WW";
		log("insertSuggest :: email:" + email);
	}
	function hoverSuggestLi(li){
		if(hoverSuggest){
			hoverSuggest.className = hoverSuggest.className.replace(/hover/, "").replace(/^\s+|\s+$/g, "");
		}
		li.className = (hoverSuggest.className + " hover").replace(/^\s+|\s+$/g, "");
		hoverSuggest = li;
	}
	function log(content){
		var infoDiv = document.getElementById("info");
		infoDiv.firstChild.innerHTML += "<br />" + content;
		infoDiv.scrollTop = infoDiv.scrollHeight - infoDiv.offsetHeight;
	}
	function htmlEscape(str) {
		if (!str) return str;
		return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
	}
	function now(){
		return new Date().getTime();
	}
</script>
</head>

<body>
<div id="emailAddr" class="email-list"></div>
	<!-- 防止编辑区域有任何空格和换行符，导致nextSibling、previousSibling不好找
	<div class="email-list-item">
		<strong>zhankui.hu</strong><em>&lt;zhankui.hu@quanshi.com&gt;</em>
	</div>
	<div class="email-list-item">
		<strong>feng.wang</strong><em>feng.wang@126.com</em>
	</div>
	<div id="item-edit" class="email-list-item-edit">
		<input id="edit" type="text" class="email-edit-input" /><span>WW</span>
	</div>
	-->


<ul id="suggest" class="suggest-email" onselectstart="return false"><li class="hover">ca<strong>n</strong>mi<strong>n</strong>.ji<strong>n</strong>@wiscom.com.cn</li><li>zha<strong>n</strong>kui.hu@quanshi.com</li><li>xi<strong>n</strong>xia<strong>n</strong>g.ya<strong>n</strong>g@quanshi.com</li><li>lo<strong>n</strong>glo<strong>n</strong>g.li@quanshi.com</li></ul>

<div id="info" class="info"><div></div></div>
</body>
</html>
